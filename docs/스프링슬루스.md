# 스프링 클라우드 슬루스와 집킨을 이용한 분산추적

마이크로서비스 아키텍처는 복잡한 모놀리식 소프트워어 시스템을 더 작고 다루기 쉬운 부분으로 분해 하고 독립적으로 빌드 및 배 포 할 수 있기 때문에 문제가 발생한 곳에서 디버깅하려는 것은 힘들다. 서비스가 분산 되어있다면 여러 서비스와 물리 머신, 다양한 데이터 저장소 사이에서 하나 이상의 트랜잭션을 추적하고 정확한 상황을 종합하려고 노력해야 한다.

## 방법 

- 상관관계 ID를 사용해 여러 서비스 사이의 트랜잭션을 서로 연결한다.
- 여러 서비스 사이의 로그 데이터를 검색 가능한 단일 소스로 수집한다. 
- 여러 서비스 사이의 사용자 트랜잭션 흐름을 시각화하고 트랜잭션 각 부분의 성능 특성을 이해한다.



## 기술 스택 

- 스프링 클라우드 슬루스 : 상관관계 ID를 사용해 HTTP 호출을 측정하는 스프링 클라우드 프로젝트이며, 생성 중인 추적 데이터를 오픈집킨에 공급할 수 있는 연결고리를 제공. 생성되는 상관관계 ID를 모든 시스템 호출로 통과시키기 위해 필터를 추가하고 다른 스프링 컴포넌트와 상호 작용하는 방식으로 슬루스를 활용.
- 페이퍼트레일 : 여러 데이터 소스의 로그 데이터를 검색이 가능한 단일 데이터베이스로 수집하는 클라우드 기반의 프리미움(freemium) 서비스.  로그 수집에 대해 사내 구축형(온프레스미)과 클라우드 기반,오픈 소스, 상용 솔루션 등 여러 대안은 있음.
- 집킨 : 여러 서비스 사이의 트랜잭션 흐름을 보여주는 오픈소스 기반의 데이터 시각화 도구. 집킨은 트랜잭션을 컴포넌트별로 분해하고 성능 과열점이 어디서 발생햇는지 시각적으로 확인이 가능하다.



## 슬루스의 역할

- 상관관계 ID가 없다면 상관관계 ID를 투명하게 생성하고 서비스 호출에 주입한다.
- 서비스에서 나가는 호출에 대한 상관관계 ID 전파를 관리해 트랜잭션의 상관관계 ID가 자동으로 나가는 호출에 추가된다.
- 상관관계 정보를 스프링 MDC 로그에 추가해 생성된 상관관계 ID가 스프링 부트의 기본 SL4J와 로그백 구현으로 자동적으로 로깅된다.
- 선택적으로 서비스의 추적 정보를 집킨 분삭 추적 플랫폼에 전송한다.

> 스프링 MDC
>
> 스프링 MDC는 즉 매핑 진단컨텍스트(MDC. Mapped Diagnostic Context)이다.





대규모 마이크로서비스 환경(특히 클라우드)에서 로그 데이터는 플랫폼을 디버깅하는 중요한 도구다. 하지만 마이크로서비스 기반의 애플리케이션 기능은 세분화된 서비스로 분산되어 있고, 한 종류의 서비스에 많은 서비스 인스턴스가 존재할 수 있기 때문에 사용자 문제를 해결하기 위해 여러 서비스에서 발생하는 로그 데이터를 한곳으로 연결하는 것은 상당한 어려운 일이다.



## 페이퍼트레일

- 무료형 계정으로 등록할 수 있는 프리미움 모델을 제공
- 설정이 매우 쉬움. 특히 도커 같은 컨테이너 런타임과 설정하기 쉽다.
- 클라우드 기반임.